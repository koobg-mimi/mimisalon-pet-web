{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/MacBook-Dev/package/mimisalon-pet-web/src/lib/email.ts"],"sourcesContent":["/**\n * Email Service\n *\n * Provides email sending functionality using Nodemailer\n * Migrated from packages/worker for direct use in Next.js app\n */\n\nimport nodemailer from 'nodemailer'\nimport { env } from './env'\n\nexport interface EmailOptions {\n  to: string\n  subject: string\n  html: string\n  text?: string\n}\n\n/**\n * Get SMTP configuration from environment variables\n */\nfunction getSMTPConfig() {\n  return {\n    host: env.SMTP_HOST,\n    port: env.SMTP_PORT,\n    secure: env.SMTP_PORT === 465, // true for 465, false for other ports\n    auth: {\n      user: env.SMTP_USERNAME,\n      pass: env.SMTP_PASSWORD,\n    },\n  }\n}\n\n/**\n * Create email transporter (lazy initialization)\n */\nlet transporter: nodemailer.Transporter | null = null\n\nfunction getEmailTransporter(): nodemailer.Transporter {\n  if (!transporter) {\n    const smtpConfig = getSMTPConfig()\n    transporter = nodemailer.createTransport(smtpConfig)\n  }\n  return transporter\n}\n\n/**\n * Send email using SMTP\n */\nexport async function sendEmail({ to, subject, html, text }: EmailOptions): Promise<{\n  success: boolean\n  messageId?: string\n  error?: string\n}> {\n  try {\n    // Validate email address\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\n    if (!emailRegex.test(to)) {\n      return {\n        success: false,\n        error: `Invalid recipient email address: ${to}`,\n      }\n    }\n\n    // Get transporter\n    const transporter = getEmailTransporter()\n\n    // Send email\n    const info = await transporter.sendMail({\n      from: env.SMTP_USERNAME,\n      to,\n      subject,\n      text: text || undefined,\n      html,\n    })\n\n    console.log('üìß Email sent successfully:', {\n      messageId: info.messageId,\n      to,\n      subject,\n    })\n\n    return {\n      success: true,\n      messageId: info.messageId,\n    }\n  } catch (error) {\n    console.error('‚ùå Failed to send email:', error)\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    }\n  }\n}\n\n/**\n * Test SMTP connection (for health checks)\n */\nexport async function testSMTPConnection(): Promise<{\n  success: boolean\n  message: string\n}> {\n  try {\n    const transporter = getEmailTransporter()\n    await transporter.verify()\n\n    return {\n      success: true,\n      message: 'SMTP connection test successful',\n    }\n  } catch (error) {\n    return {\n      success: false,\n      message: error instanceof Error ? error.message : 'Unknown error',\n    }\n  }\n}\n\n/**\n * Check SMTP health without connecting\n */\nexport function checkSMTPHealth(): { healthy: boolean; message: string } {\n  try {\n    const config = getSMTPConfig()\n\n    if (!config.host || !config.auth.user || !config.auth.pass) {\n      return {\n        healthy: false,\n        message: 'SMTP configuration is incomplete',\n      }\n    }\n\n    return {\n      healthy: true,\n      message: `SMTP configured for ${config.host}:${config.port}`,\n    }\n  } catch (error) {\n    return {\n      healthy: false,\n      message: error instanceof Error ? error.message : 'Unknown SMTP error',\n    }\n  }\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;AAED;AACA;;;AASA;;CAEC,GACD,SAAS;IACP,OAAO;QACL,MAAM,0HAAG,CAAC,SAAS;QACnB,MAAM,0HAAG,CAAC,SAAS;QACnB,QAAQ,0HAAG,CAAC,SAAS,KAAK;QAC1B,MAAM;YACJ,MAAM,0HAAG,CAAC,aAAa;YACvB,MAAM,0HAAG,CAAC,aAAa;QACzB;IACF;AACF;AAEA;;CAEC,GACD,IAAI,cAA6C;AAEjD,SAAS;IACP,IAAI,CAAC,aAAa;QAChB,MAAM,aAAa;QACnB,cAAc,wHAAU,CAAC,eAAe,CAAC;IAC3C;IACA,OAAO;AACT;AAKO,eAAe,UAAU,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAgB;IAKvE,IAAI;QACF,yBAAyB;QACzB,MAAM,aAAa;QACnB,IAAI,CAAC,WAAW,IAAI,CAAC,KAAK;YACxB,OAAO;gBACL,SAAS;gBACT,OAAO,CAAC,iCAAiC,EAAE,IAAI;YACjD;QACF;QAEA,kBAAkB;QAClB,MAAM,cAAc;QAEpB,aAAa;QACb,MAAM,OAAO,MAAM,YAAY,QAAQ,CAAC;YACtC,MAAM,0HAAG,CAAC,aAAa;YACvB;YACA;YACA,MAAM,QAAQ;YACd;QACF;QAEA,QAAQ,GAAG,CAAC,+BAA+B;YACzC,WAAW,KAAK,SAAS;YACzB;YACA;QACF;QAEA,OAAO;YACL,SAAS;YACT,WAAW,KAAK,SAAS;QAC3B;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO;YACL,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAClD;IACF;AACF;AAKO,eAAe;IAIpB,IAAI;QACF,MAAM,cAAc;QACpB,MAAM,YAAY,MAAM;QAExB,OAAO;YACL,SAAS;YACT,SAAS;QACX;IACF,EAAE,OAAO,OAAO;QACd,OAAO;YACL,SAAS;YACT,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD;IACF;AACF;AAKO,SAAS;IACd,IAAI;QACF,MAAM,SAAS;QAEf,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,EAAE;YAC1D,OAAO;gBACL,SAAS;gBACT,SAAS;YACX;QACF;QAEA,OAAO;YACL,SAAS;YACT,SAAS,CAAC,oBAAoB,EAAE,OAAO,IAAI,CAAC,CAAC,EAAE,OAAO,IAAI,EAAE;QAC9D;IACF,EAAE,OAAO,OAAO;QACd,OAAO;YACL,SAAS;YACT,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD;IACF;AACF","debugId":null}}]
}