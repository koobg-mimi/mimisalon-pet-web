module.exports=[849645,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(114444),s=e.i(837092),d=e.i(869741),l=e.i(316795),u=e.i(487718),c=e.i(995169),p=e.i(47587),m=e.i(666012),g=e.i(570101),h=e.i(626937),f=e.i(10372),R=e.i(193695);e.i(52474);var v=e.i(600220),b=e.i(166748),w=e.i(89171),y=e.i(493458),I=e.i(79832),N=e.i(657446),E=e.i(469719),P=e.i(398163),k=e.i(616300);let C=E.z.object({paymentId:E.z.string(),petServices:E.z.array(E.z.object({petId:E.z.string(),services:E.z.array(E.z.object({id:E.z.string(),name:E.z.string(),basePrice:E.z.number(),duration:E.z.number()}))})),addressId:E.z.string(),customerAddress:E.z.object({street:E.z.string(),city:E.z.string(),state:E.z.string(),zipCode:E.z.string(),detailAddress:E.z.string().optional()}).optional(),groomerId:E.z.string().min(1,"미용사를 선택해주세요"),date:E.z.string().min(1,"날짜를 선택해주세요"),timeSlot:E.z.string().min(1,"시간을 선택해주세요").regex(/^\d{2}:\d{2}$/,"올바른 시간 형식이 아닙니다 (HH:mm)"),specialRequests:E.z.string().optional()});async function x(e){try{let t=await I.default.api.getSession({headers:await (0,y.headers)()});if(!t?.user?.email)return w.NextResponse.json({error:"Unauthorized"},{status:401});if("CUSTOMER"!==t.user.role)return w.NextResponse.json({error:"Forbidden"},{status:403});let r=e.nextUrl.searchParams,a=parseInt(r.get("page")||"1"),i=parseInt(r.get("limit")||"10"),n=r.get("status"),o=r.get("sort_by")||"serviceDate",s=r.get("sort_order")||"desc",d=await N.prisma.user.findUnique({where:{email:t.user.email}});if(!d)return w.NextResponse.json({error:"User not found"},{status:404});let l={customerId:d.id};if(n){let e=n.split(",").filter(Boolean);1===e.length?l.status=e[0]:e.length>1&&(l.status={in:e})}let u=await N.prisma.booking.count({where:l}),c=(await N.prisma.booking.findMany({where:l,include:{groomer:{select:{id:!0,name:!0,email:!0}},pet:{select:{id:!0,name:!0,type:!0,breed:{select:{id:!0,name:!0}}}},bookingPets:{include:{pet:{include:{breed:{select:{id:!0,name:!0}}}},services:{include:{service:!0}},selectedOptions:{include:{serviceOption:!0}}}},payments:{select:{id:!0,amount:!0,status:!0,paidAt:!0}}},orderBy:{[o]:s},skip:(a-1)*i,take:i})).map(e=>({id:e.id,bookingNumber:e.bookingNumber,serviceDate:e.serviceDate,serviceTime:e.serviceTime,status:e.status,paymentStatus:e.paymentStatus,serviceType:e.serviceType,totalPrice:e.totalPrice,totalAmount:e.totalPrice,additionalCharges:e.additionalCharges,groomer:e.groomer,pet:e.pet||e.bookingPets[0]?.pet,pets:e.bookingPets.map(e=>e.pet),services:e.bookingPets.flatMap(e=>e.services.map(e=>e.service)),options:e.bookingPets.flatMap(e=>e.selectedOptions.map(e=>({name:e.serviceOption.name,price:e.optionPrice}))),payments:e.payments,customerRating:e.customerRating,customerReview:e.customerReview,createdAt:e.createdAt,updatedAt:e.updatedAt}));return w.NextResponse.json({bookings:c,totalBookings:u,totalPages:Math.ceil(u/i),page:a,size:i,first:1===a,last:a>=Math.ceil(u/i)})}catch(e){return console.error("Customer bookings error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}async function A(e){let t;try{let r=await I.default.api.getSession({headers:await (0,y.headers)()});if(!r?.user?.email)return w.NextResponse.json({error:"Unauthorized"},{status:401});if("CUSTOMER"!==r.user.role)return w.NextResponse.json({error:"Forbidden"},{status:403});let a=await e.json(),i=C.parse(a);t=i.paymentId;let n=await N.prisma.user.findUnique({where:{email:r.user.email}});if(!n)return w.NextResponse.json({error:"User not found"},{status:404});let o=await N.prisma.payment.findUnique({where:{paymentId:i.paymentId},include:{booking:!0}}),s=o;if(!o){console.log("Payment not found, creating new PENDING payment:",i.paymentId);let e=i.petServices.reduce((e,t)=>e+t.services.reduce((e,t)=>e+t.basePrice,0),0);s=await N.prisma.payment.create({data:{paymentId:i.paymentId,status:"PENDING",amount:e,currency:"KRW",customerId:n.id,orderName:`${i.petServices[0].services[0].name} 외`,method:"PENDING"},include:{booking:!0}})}if(!s||"PAID"!==s.status&&"PENDING"!==s.status)return console.error("Payment in invalid status:",s?.status),w.NextResponse.json({error:"Payment not valid",status:s?.status||"UNKNOWN",message:"결제가 유효하지 않습니다."},{status:400});if(s&&"PENDING"===s.status){let e=new Date(Date.now()-3e5);if(s&&s.createdAt<e)return w.NextResponse.json({error:"Payment timeout",message:"결제 처리 시간이 초과되었습니다."},{status:408});console.log("Payment is PENDING but recent, proceeding with booking creation")}if(s&&s.customerId&&s.customerId!==n.id)return w.NextResponse.json({error:"Payment belongs to another user"},{status:403});if(s&&s.bookingId)return w.NextResponse.json({error:"Payment already used for another booking"},{status:400});let d=i.petServices.reduce((e,t)=>e+t.services.reduce((e,t)=>e+t.basePrice,0),0);if(!s||s.amount!==d)return console.error("Payment amount mismatch:",{expected:d,actual:s?.amount}),w.NextResponse.json({error:"Payment amount mismatch"},{status:400});if(!await N.prisma.user.findFirst({where:{id:i.groomerId,role:"GROOMER"}}))return w.NextResponse.json({error:"Groomer not found"},{status:404});let l=i.petServices.reduce((e,t)=>e+t.services.reduce((e,t)=>e+(t.duration||60),0),0),u=(0,k.generateRequiredTimeSlots)(i.timeSlot,l+k.CLEANUP_BUFFER_MINUTES),c=await (0,k.checkGroomerAvailability)(i.groomerId,new Date(i.date),u);if(!c.available)return w.NextResponse.json({error:"선택한 시간대가 이미 예약되었습니다",conflicts:c.conflicts,message:`다음 시간이 이미 예약되어 있습니다: ${c.conflicts?.join(", ")}`},{status:409});let p=`BK${Date.now()}`,m=await N.prisma.$transaction(async e=>{if(await e.booking.findFirst({where:{groomerId:i.groomerId,serviceDate:new Date(i.date),status:{notIn:["SERVICE_CANCELLED","BOOKING_FAILED"]},OR:u.map(e=>({AND:[{serviceTime:{lte:e}},{}]}))}}))throw Error("시간대가 다른 예약과 충돌합니다. 다른 시간을 선택해주세요.");let t=await e.booking.create({data:{bookingNumber:p,customerId:n.id,groomerId:i.groomerId,serviceDate:new Date(i.date),serviceTime:i.timeSlot,basePrice:d,additionalCharges:0,totalPrice:d,status:s?.status==="PAID"?"FIRST_PAYMENT_COMPLETE":"FIRST_PAYMENT_PENDING",paymentStatus:s?.status==="PAID"?"PAID":"PENDING",serviceType:"GROOMING",specialRequests:i.specialRequests,customerAddressId:i.addressId,estimatedDurationMinutes:l}});for(let r of(await (0,k.blockTimeSlots)(e,i.groomerId,new Date(i.date),u,t.id),i.petServices)){let a=await e.bookingPet.create({data:{bookingId:t.id,petId:r.petId}});for(let t of r.services)await e.bookingService.create({data:{bookingPetId:a.id,serviceId:t.id,servicePrice:t.basePrice}})}return await e.payment.update({where:{paymentId:i.paymentId},data:{bookingId:t.id}}),t}),g=await N.prisma.booking.findUnique({where:{id:m.id},include:{groomer:{select:{id:!0,name:!0,email:!0}},bookingPets:{include:{pet:{include:{breed:{select:{id:!0,name:!0}}}},services:{include:{service:!0}},selectedOptions:{include:{serviceOption:!0}}}},payments:!0}});try{await P.workerApiClient.cancelPaymentCleanup(i.paymentId),console.log(`[Booking Create] Cancelled cleanup job for successful payment: ${i.paymentId}`)}catch(e){console.error("[Booking Create] Failed to cancel cleanup job:",e)}try{let e=(0,b.parseISO)(`${i.date}T${i.timeSlot}`);await P.workerApiClient.scheduleBookingReminder({bookingId:m.id,serviceDateTime:e.toISOString()}),await P.workerApiClient.scheduleTodayNotification({bookingId:m.id,serviceDate:e.toISOString()}),await P.workerApiClient.sendImmediateNotification({type:"status_update",bookingId:m.id,targetAudience:"GROOMER",title:"새로운 예약 요청",body:`${n.name}님이 새로운 미용 예약을 요청했습니다.`,data:{bookingNumber:m.bookingNumber,serviceDate:i.date,serviceTime:i.timeSlot}}),console.log(`Scheduled notifications for booking: ${m.id}`)}catch(e){console.error("Failed to schedule notifications:",e)}return w.NextResponse.json(g,{status:201})}catch(e){try{t&&(await P.workerApiClient.executePaymentCleanup({paymentId:t}),console.log(`[Booking Create] Executed immediate cleanup for failed booking: ${t}`))}catch(e){console.error("[Booking Create] Failed to execute immediate cleanup:",e)}if(e instanceof E.z.ZodError)return w.NextResponse.json({error:"Invalid request data",details:e.issues},{status:400});if(e instanceof Error&&(e.message.includes("충돌")||e.message.includes("예약")))return w.NextResponse.json({error:e.message,code:"BOOKING_CONFLICT"},{status:409});return console.error("Booking creation error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>x,"POST",()=>A],191435);var S=e.i(191435);let T=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/customer/bookings/route",pathname:"/api/customer/bookings",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/customer/bookings/route.ts",nextConfigOutput:"standalone",userland:S}),{workAsyncStorage:O,workUnitAsyncStorage:D,serverHooks:j}=T;function _(){return(0,a.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:D})}async function M(e,t,a){T.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/customer/bookings/route";b=b.replace(/\/index$/,"")||"/";let w=await T.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:I,nextConfig:N,parsedUrl:E,isDraftMode:P,prerenderManifest:k,routerServerContext:C,isOnDemandRevalidate:x,revalidateOnlyGenerated:A,resolvedPathname:S,clientReferenceManifest:O,serverActionsManifest:D}=w,j=(0,d.normalizeAppPath)(b),_=!!(k.dynamicRoutes[j]||k.routes[S]),M=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,E,!1):t.end("This page could not be found"),null);if(_&&!P){let e=!!k.routes[S],t=k.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(N.experimental.adapterPath)return await M();throw new R.NoFallbackError}}let U=null;!_||T.isDev||P||(U="/index"===(U=S)?"/":U);let z=!0===T.isDev||!_,q=_&&!z;D&&O&&(0,o.setReferenceManifestsSingleton)({page:b,clientReferenceManifest:O,serverActionsManifest:D,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:D})});let F=e.method||"GET",G=(0,n.getTracer)(),$=G.getActiveScopeSpan(),H={params:I,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!N.experimental.authInterrupts},cacheComponents:!!N.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:N.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>T.onRequestError(e,t,a,C)},sharedContext:{buildId:y}},B=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),L=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let o=async e=>T.handle(L,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=G.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${b}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var n,d;let l=async({previousCacheEntry:r})=>{try{if(!s&&x&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=H.renderOpts.fetchMetrics;let d=H.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=H.renderOpts.collectedTags;if(!_)return await (0,m.sendResponse)(B,K,n,H.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[f.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,a=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:x})},C),t}},u=await T.handleResponse({req:e,nextConfig:N,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:A,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:s});if(!_)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",x?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&_||c.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(B,K,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};$?await d($):await G.withPropagatedContext(e.headers,()=>G.trace(c.BaseServerSpan.handleRequest,{spanName:`${F} ${b}`,kind:n.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},d))}catch(t){if(t instanceof R.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:x})}),_)throw t;return await (0,m.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>_,"routeModule",()=>T,"serverHooks",()=>j,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>D],849645)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_6b777c6c.js.map