module.exports=[387262,e=>{"use strict";var t=e.i(747909),n=e.i(174017),a=e.i(996250),o=e.i(759756),r=e.i(561916),s=e.i(114444),i=e.i(837092),l=e.i(869741),u=e.i(316795),d=e.i(487718),c=e.i(995169),p=e.i(47587),R=e.i(666012),E=e.i(570101),m=e.i(626937),f=e.i(10372),g=e.i(193695);e.i(52474);var C=e.i(600220),h=e.i(89171),A=e.i(493458),y=e.i(79832),N=e.i(657446),I=e.i(469719),S=e.i(343747),w=e.i(686880),O=e.i(398163),b=e.i(378725);let _=I.z.object({status:I.z.enum(N.BookingStatus),reason:I.z.string().optional()});async function v(e,{params:t}){try{let n=await y.default.api.getSession({headers:await (0,A.headers)()});if(!n?.user||"GROOMER"!==n.user.role)return h.NextResponse.json({error:"미용사 권한이 필요합니다"},{status:403});let{id:a}=await t,o=await e.json(),{status:r,reason:s}=_.parse(o),i=await N.prisma.booking.findUnique({where:{id:a},include:{customer:!0,groomer:!0,payments:{where:{status:{in:[N.PaymentStatus.PAID,N.PaymentStatus.COMPLETED]}}},bookingPets:{include:{pet:!0,services:{include:{service:!0}}}}}});if(!i)return h.NextResponse.json({error:"예약을 찾을 수 없습니다"},{status:404});if(i.groomerId!==n.user.id)return h.NextResponse.json({error:"해당 예약에 대한 권한이 없습니다"},{status:403});if(!(({FIRST_PAYMENT_COMPLETE:["GROOMER_CONFIRM","SERVICE_CANCELLED"],GROOMER_CONFIRM_PENDING:["GROOMER_CONFIRM","SERVICE_CANCELLED"],GROOMER_CONFIRM:["WORK_IN_PROGRESS","SERVICE_CANCELLED"],ADDITIONAL_PAYMENT_COMPLETE:["WORK_IN_PROGRESS","SERVICE_CANCELLED"],WORK_IN_PROGRESS:["SERVICE_COMPLETED","SERVICE_CANCELLED"]})[i.status]||[]).includes(r))return h.NextResponse.json({error:`현재 상태(${i.status})에서 ${r}로 변경할 수 없습니다`},{status:400});let l={status:r,updatedAt:new Date};switch(r){case"GROOMER_CONFIRM":l.confirmedAt=new Date;break;case"WORK_IN_PROGRESS":l.startedAt=new Date;break;case"SERVICE_COMPLETED":l.completedAt=new Date;break;case"SERVICE_CANCELLED":l.cancelledAt=new Date,l.cancellationReason=s||"미용사가 예약을 거절했습니다",l.cancelledBy=n.user.id}let u={successful:[],failed:[],totalRefundAmount:0};if("SERVICE_CANCELLED"===r&&i.payments.length>0){console.log(`[Groomer Reject] Processing refunds for booking ${i.bookingNumber}`);let e=`미용사 예약 거절 - 예약번호: ${i.bookingNumber} (${s||"미용사가 예약을 거절했습니다"})`;for(let t of i.payments)try{console.log(`[Groomer Reject] Processing payment cancellation for paymentId: ${t.paymentId}`),await (0,b.cancelPayment)(t.paymentId,e),u.successful.push(t.paymentId),u.totalRefundAmount+=t.amount,console.log(`[Groomer Reject] Successfully cancelled payment: ${t.paymentId}`)}catch(e){console.error(`[Groomer Reject] Failed to cancel payment ${t.paymentId}:`,e),e instanceof Error&&e.message.includes("already cancelled")?(u.successful.push(t.paymentId),u.totalRefundAmount+=t.amount):u.failed.push({paymentId:t.paymentId,error:e instanceof Error?e.message:"Unknown error"})}}let d=await N.prisma.$transaction(async e=>("SERVICE_CANCELLED"===r&&u.successful.length>0&&(await e.payment.updateMany({where:{bookingId:a,paymentId:{in:u.successful}},data:{status:N.PaymentStatus.CANCELLED,cancelledAt:new Date,cancelReason:"미용사 예약 거절로 인한 자동 환불",cancelledAmount:i.totalPrice}}),l.paymentStatus=N.PaymentStatus.CANCELLED),e.booking.update({where:{id:a},data:l,include:{customer:!0,groomer:!0,bookingPets:{include:{pet:!0,services:{include:{service:!0}}}},payments:!0}})));return await P({id:d.id,serviceDate:d.serviceDate,bookingNumber:d.bookingNumber,cancellationReason:d.cancellationReason||void 0,groomer:{name:d.groomer?.name||"미용사"},bookingPets:d.bookingPets.map(e=>({pet:{name:e.pet.name}})),refundInfo:"SERVICE_CANCELLED"===r?{totalRefundAmount:u.totalRefundAmount,successfulRefunds:u.successful.length,failedRefunds:u.failed.length}:void 0},r),"SERVICE_CANCELLED"===r&&await O.workerApiClient.cancelBookingNotifications(a),h.NextResponse.json({message:"SERVICE_CANCELLED"===r&&u.successful.length>0?`예약이 취소되고 ${u.totalRefundAmount.toLocaleString("ko-KR")}원이 환불 처리되었습니다`:"예약 상태가 성공적으로 업데이트되었습니다",booking:{id:d.id,status:d.status,confirmedAt:d.confirmedAt,startedAt:d.startedAt,completedAt:d.completedAt,cancelledAt:d.cancelledAt},..."SERVICE_CANCELLED"===r&&i.payments.length>0&&{refundResults:{totalPayments:i.payments.length,successfulRefunds:u.successful.length,failedRefunds:u.failed.length,totalRefundAmount:u.totalRefundAmount,...u.failed.length>0&&{failedDetails:u.failed}}}})}catch(e){if(console.error("Booking status update error:",e),e instanceof I.z.ZodError)return h.NextResponse.json({error:"잘못된 요청 데이터입니다",details:e.issues},{status:400});return h.NextResponse.json({error:"예약 상태 업데이트 중 오류가 발생했습니다"},{status:500})}}async function P(e,t){try{let n={GROOMER_CONFIRM:{title:"예약이 확정되었습니다",body:`${e.groomer.name} 미용사가 예약을 승인했습니다. 예약일: ${(0,S.format)(e.serviceDate,"yyyy년 MM월 dd일",{locale:w.ko})}`},WORK_IN_PROGRESS:{title:"미용 서비스가 시작되었습니다",body:`${e.bookingPets[0]?.pet.name}의 미용이 시작되었습니다.`},SERVICE_COMPLETED:{title:"미용 서비스가 완료되었습니다",body:`${e.bookingPets[0]?.pet.name}의 미용이 완료되었습니다. 리뷰를 작성해주세요!`},SERVICE_CANCELLED:{title:"예약이 취소되었습니다",body:e.refundInfo&&e.refundInfo.successfulRefunds>0?`죄송합니다. 예약이 취소되었습니다. ${e.refundInfo.totalRefundAmount.toLocaleString("ko-KR")}원이 자동으로 환불 처리되었습니다. ${e.cancellationReason||""}`:`죄송합니다. 예약이 취소되었습니다. ${e.cancellationReason||"자세한 사항은 고객센터로 문의해주세요."}`}}[t];if(!n)return;await O.workerApiClient.sendImmediateNotification({type:"status_update",bookingId:e.id,targetAudience:"CUSTOMER",title:n.title,body:n.body,data:{bookingId:e.id,type:"BOOKING_STATUS_UPDATE",status:t,bookingNumber:e.bookingNumber}}),console.log(`Queued status update notification for booking ${e.id}: ${t}`)}catch(e){console.error("Error queuing notification:",e)}}e.s(["PUT",()=>v,"updateBookingStatusSchema",0,_],411672);var k=e.i(411672);let D=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/groomer/bookings/[id]/status/route",pathname:"/api/groomer/bookings/[id]/status",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/groomer/bookings/[id]/status/route.ts",nextConfigOutput:"standalone",userland:k}),{workAsyncStorage:L,workUnitAsyncStorage:M,serverHooks:T}=D;function x(){return(0,a.patchFetch)({workAsyncStorage:L,workUnitAsyncStorage:M})}async function $(e,t,a){D.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let h="/api/groomer/bookings/[id]/status/route";h=h.replace(/\/index$/,"")||"/";let A=await D.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!A)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:N,nextConfig:I,parsedUrl:S,isDraftMode:w,prerenderManifest:O,routerServerContext:b,isOnDemandRevalidate:_,revalidateOnlyGenerated:v,resolvedPathname:P,clientReferenceManifest:k,serverActionsManifest:L}=A,M=(0,l.normalizeAppPath)(h),T=!!(O.dynamicRoutes[M]||O.routes[P]),x=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,S,!1):t.end("This page could not be found"),null);if(T&&!w){let e=!!O.routes[P],t=O.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await x();throw new g.NoFallbackError}}let $=null;!T||D.isDev||w||($="/index"===($=P)?"/":$);let U=!0===D.isDev||!T,G=T&&!U;L&&k&&(0,s.setReferenceManifestsSingleton)({page:h,clientReferenceManifest:k,serverActionsManifest:L,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:L})});let j=e.method||"GET",V=(0,r.getTracer)(),H=V.getActiveScopeSpan(),q={params:N,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>D.onRequestError(e,t,a,b)},sharedContext:{buildId:y}},F=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(F,(0,d.signalFromNodeResponse)(t));try{let s=async e=>D.handle(B,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=V.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${j} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${h}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var r,l;let u=async({previousCacheEntry:n})=>{try{if(!i&&_&&v&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await s(o);e.fetchMetrics=q.renderOpts.fetchMetrics;let l=q.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=q.renderOpts.collectedTags;if(!T)return await (0,R.sendResponse)(F,K,r,q.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(r.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,a=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:C.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:_})},b),t}},d=await D.handleResponse({req:e,nextConfig:I,cacheKey:$,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:v,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:i});if(!T)return null;if((null==d||null==(r=d.value)?void 0:r.kind)!==C.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",_?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),w&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,E.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&T||c.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,R.sendResponse)(F,K,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};H?await l(H):await V.withPropagatedContext(e.headers,()=>V.trace(c.BaseServerSpan.handleRequest,{spanName:`${j} ${h}`,kind:r.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:_})}),T)throw t;return await (0,R.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>x,"routeModule",()=>D,"serverHooks",()=>T,"workAsyncStorage",()=>L,"workUnitAsyncStorage",()=>M],387262)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_12827718.js.map