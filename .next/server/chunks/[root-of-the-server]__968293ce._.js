module.exports=[254799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},609730,438220,874321,e=>{"use strict";let t=Symbol.for("constructDateFrom");function r(e,r){return"function"==typeof e?e(r):e&&"object"==typeof e&&t in e?e[t](r):e instanceof Date?new e.constructor(r):new Date(r)}function o(e,t){return r(t||e,e)}e.s(["constructFromSymbol",0,t,"millisecondsInDay",0,864e5,"millisecondsInHour",0,36e5,"millisecondsInMinute",0,6e4,"millisecondsInWeek",0,6048e5],438220),e.s(["constructFrom",()=>r],874321),e.s(["toDate",()=>o],609730)},250354,662001,e=>{"use strict";let t={};function r(){return t}e.s(["getDefaultOptions",()=>r],662001);var o=e.i(609730);function s(e,r){let s=r?.weekStartsOn??r?.locale?.options?.weekStartsOn??t.weekStartsOn??t.locale?.options?.weekStartsOn??0,a=(0,o.toDate)(e,r?.in),n=a.getDay();return a.setDate(a.getDate()-(7*(n<s)+n-s)),a.setHours(0,0,0,0),a}e.s(["startOfWeek",()=>s],250354)},528164,458325,e=>{"use strict";var t=e.i(662001),r=e.i(609730);function o(e,o){let s=(0,t.getDefaultOptions)(),a=o?.weekStartsOn??o?.locale?.options?.weekStartsOn??s.weekStartsOn??s.locale?.options?.weekStartsOn??0,n=(0,r.toDate)(e,o?.in),i=n.getDay();return n.setDate(n.getDate()+((i<a?-7:0)+6-(i-a))),n.setHours(23,59,59,999),n}e.s(["endOfWeek",()=>o],528164);var s=e.i(874321);function a(e,t,o){var a;let n;return a=-(7*t),n=(0,r.toDate)(e,o?.in),isNaN(a)?(0,s.constructFrom)(o?.in||e,NaN):(a&&n.setDate(n.getDate()+a),n)}e.s(["subWeeks",()=>a],458325)},905404,e=>{"use strict";var t=e.i(657446);class r{static validateGroomer(e){return e.groomerProfile?e.groomerProfile.commissionGrade?e.groomerProfile.commissionGrade.commissionRate?{isValid:!0}:{isValid:!1,reason:"no_commission_rate",details:"수수료율이 설정되지 않았습니다"}:{isValid:!1,reason:"no_commission_grade",details:"수수료 등급이 설정되지 않았습니다"}:{isValid:!1,reason:"no_profile",details:"미용사 프로필이 없습니다"}}static calculateSettlement(e,t,r=0){if(0===e.length)return{totalRevenue:0,commissionRate:t,platformCommission:0,netSettlementAmount:0,taxAmount:0,bookingCount:0};let o=e.reduce((e,t)=>e+t.totalPrice,0),s=t/100*o,a=r>0?r/100*o:0;return{totalRevenue:o,commissionRate:t,platformCommission:s,netSettlementAmount:o-s-a,taxAmount:a,bookingCount:e.length}}static async fetchActiveGroomers(){return await t.prisma.user.findMany({where:{role:"GROOMER",groomerProfile:{isActive:!0,isSettlementActive:!0}},select:{id:!0,name:!0,email:!0,groomerProfile:{select:{id:!0,groomerId:!0,commissionGradeId:!0,taxRate:!0,portonePartnerId:!0,portoneContractId:!0,commissionGrade:{select:{id:!0,name:!0,commissionRate:!0}}}}}})}static async fetchBookingsForGroomers(e,r,o){let s=await t.prisma.booking.findMany({where:{groomerId:{in:e},status:"SERVICE_COMPLETED",completedAt:{gte:r,lte:o}},select:{id:!0,bookingNumber:!0,totalPrice:!0,completedAt:!0,groomerId:!0,payments:{where:{status:"PAID"},select:{id:!0,paymentId:!0,status:!0,amount:!0,paidAt:!0}}}}),a=new Map;for(let e of s){let{groomerId:t,...r}=e;if(!t){console.warn(`Booking ${e.id} has no groomerId, skipping`);continue}a.has(t)||a.set(t,[]),a.get(t).push(r)}return a}static async checkExistingSettlements(e,r,o){return new Set((await t.prisma.groomerSettlement.findMany({where:{groomerId:{in:e},periodStartDate:r,periodEndDate:o},select:{groomerId:!0}})).map(e=>e.groomerId))}static async createSettlement(e,r,o,s,a,n){return await t.prisma.$transaction(async t=>{let i=await t.groomerSettlement.create({data:{groomerId:e.id,groomerProfileId:e.groomerProfile.id,settlementDate:new Date,periodStartDate:s,periodEndDate:a,totalRevenue:o.totalRevenue,commissionRate:o.commissionRate,commissionAmount:o.platformCommission,taxAmount:o.taxAmount,netSettlementAmount:o.netSettlementAmount,status:"CALCULATED",bookingCount:o.bookingCount,notes:n||"자동 정산",processedAt:new Date}});for(let s of r){let r=s.totalPrice*(o.commissionRate/100),a=o.taxAmount>0?s.totalPrice*(o.taxAmount/o.totalRevenue):0,n=s.totalPrice-r-a;await t.groomerSettlementDetail.create({data:{settlementId:i.id,groomerProfileId:e.groomerProfile.id,bookingId:s.id,bookingDate:s.completedAt,serviceAmount:s.totalPrice,commissionRate:o.commissionRate,commissionAmount:r,taxAmount:a,netAmount:n}})}return i.id})}static async processSettlements(e,t,r={}){let{skipExisting:o=!0,dryRun:s=!1,onProgress:a}=r,n=await this.fetchActiveGroomers(),i=[],l=0;a?.({completed:0,total:n.length,current:"Fetching groomer data..."});let c=n.map(e=>e.id),u=o?await this.checkExistingSettlements(c,e,t):new Set,d=await this.fetchBookingsForGroomers(c,e,t);a?.({completed:0,total:n.length,current:"Processing settlements..."});let m=0;for(let r of n){try{let o;if(a?.({completed:m,total:n.length,current:`Processing ${r.name||r.email}...`}),u.has(r.id)){i.push({groomerId:r.id,groomerName:r.name||"알 수 없음",status:"skipped",reason:"already_exists"}),m++;continue}let c=this.validateGroomer(r);if(!c.isValid){i.push({groomerId:r.id,groomerName:r.name||"알 수 없음",status:"skipped",reason:c.reason,error:c.details}),m++;continue}let p=d.get(r.id)||[];if(0===p.length){i.push({groomerId:r.id,groomerName:r.name||"알 수 없음",status:"skipped",reason:"no_bookings"}),m++;continue}let f=this.calculateSettlement(p,r.groomerProfile.commissionGrade.commissionRate,r.groomerProfile.taxRate);s||(o=await this.createSettlement(r,p,f,e,t,"배치 자동 정산")),i.push({groomerId:r.id,groomerName:r.name||"알 수 없음",status:"success",settlementId:o,calculation:f}),l+=f.netSettlementAmount}catch(e){i.push({groomerId:r.id,groomerName:r.name||"알 수 없음",status:"failed",error:e instanceof Error?e.message:"알 수 없는 오류"})}m++}a?.({completed:m,total:n.length,current:"Complete!"});let p={total:i.length,successful:i.filter(e=>"success"===e.status).length,failed:i.filter(e=>"failed"===e.status).length,skipped:i.filter(e=>"skipped"===e.status).length,totalAmount:l};return{results:i,summary:p}}}e.s(["SettlementCalculator",()=>r])},327031,e=>{"use strict";var t=e.i(747909),r=e.i(174017),o=e.i(996250),s=e.i(759756),a=e.i(561916),n=e.i(114444),i=e.i(837092),l=e.i(869741),c=e.i(316795),u=e.i(487718),d=e.i(995169),m=e.i(47587),p=e.i(666012),f=e.i(570101),g=e.i(626937),h=e.i(10372),k=e.i(193695);e.i(52474);var v=e.i(600220),R=e.i(686880),w=e.i(89171),_=e.i(493458),y=e.i(79832),S=e.i(250354),A=e.i(528164),E=e.i(458325),C=e.i(343747),I=e.i(905404),b=e.i(547499);async function x(e){try{let t,r,o,s,a,n=e.headers.get("Authorization");if("Default"!==n){let e=await y.default.api.getSession({headers:await (0,_.headers)()});if(!e||e.user?.role!=="ADMIN")return w.NextResponse.json({error:"관리자 권한이 필요합니다"},{status:403})}try{if(t=(await e.json().catch(()=>({}))).weekOffset??1,"number"!=typeof t||t<0||t>52)return w.NextResponse.json({error:"weekOffset은 0부터 52 사이의 숫자여야 합니다",received:t},{status:400});let s=(0,E.subWeeks)(new Date,t);r=(0,S.startOfWeek)(s,{weekStartsOn:1}),o=(0,A.endOfWeek)(s,{weekStartsOn:1})}catch(e){return w.NextResponse.json({error:"요청 데이터 파싱 중 오류가 발생했습니다",details:e instanceof Error?e.message:"알 수 없는 오류"},{status:400})}try{let e=await I.SettlementCalculator.processSettlements(r,o,{skipExisting:!0,dryRun:!1,onProgress:e=>{console.log(`정산 진행률: ${e.completed}/${e.total} (${e.current})`)}});s=e.results,a=e.summary}catch(e){return console.error("Settlement processing failed:",e),w.NextResponse.json({error:"정산 처리 중 시스템 오류가 발생했습니다",details:e instanceof Error?e.message:"알 수 없는 오류",period:{start:r.toISOString(),end:o.toISOString()}},{status:500})}let i=s.filter(e=>"success"===e.status).map(e=>{try{return{groomerId:e.groomerId,groomerName:e.groomerName,settlementId:e.settlementId,bookingCount:e.calculation?.bookingCount||0,totalRevenue:e.calculation?.totalRevenue||0,platformCommission:e.calculation?.platformCommission||0,netAmount:e.calculation?.netSettlementAmount||0,status:"success"}}catch(t){return console.error(`Error processing successful result for ${e.groomerId}:`,t),null}}).filter(e=>null!==e),l=s.filter(e=>"skipped"===e.status).map(e=>({groomerId:e.groomerId,groomerName:e.groomerName,reason:e.reason||"unknown",details:e.error})),c=s.filter(e=>"failed"===e.status).map(e=>({groomerId:e.groomerId,groomerName:e.groomerName,reason:"failed",error:e.error||"알 수 없는 오류"})),u={activeGroomers:[],results:i,skippedGroomers:[...l,...c],totalCreated:a.successful,totalAmount:a.totalAmount};if((a.failed>0||a.skipped>0)&&(console.warn(`정산 처리 완료 - 성공: ${a.successful}, 실패: ${a.failed}, 건너뜀: ${a.skipped}`),a.failed>0)){let e=c.map(e=>`${e.groomerName}(${e.groomerId}): ${e.error}`).join(", ");console.error(`실패한 정산들: ${e}`)}let d=a.failed>0,m=a.successful>0,p=m&&(d||a.skipped>0),f=200,g=`${(0,C.format)(r,"yyyy-MM-dd",{locale:R.ko})} ~ ${(0,C.format)(o,"yyyy-MM-dd",{locale:R.ko})} 기간 정산이 생성되었습니다`;return!m&&d?(f=500,g="모든 정산 처리가 실패했습니다"):p&&(f=207,g=`부분 성공: ${a.successful}개 성공, ${a.failed}개 실패, ${a.skipped}개 건너뜀`),w.NextResponse.json({success:m,partialSuccess:p,message:g,summary:{period:{start:r.toISOString(),end:o.toISOString()},totalGroomers:a.total,totalCreated:u.totalCreated,totalSkipped:u.skippedGroomers.length,totalAmount:u.totalAmount,failed:a.failed,skippedReasons:{noCommissionRate:s.filter(e=>"no_commission_rate"===e.reason||"no_commission_grade"===e.reason).length,alreadyExists:s.filter(e=>"already_exists"===e.reason).length,noBookings:s.filter(e=>"no_bookings"===e.reason).length,belowMinimum:s.filter(e=>"below_minimum"===e.reason).length,noProfile:s.filter(e=>"no_profile"===e.reason).length,systemErrors:a.failed}},results:u.results,skippedGroomers:u.skippedGroomers,errors:d?c:void 0},{status:f})}catch(e){return console.error("Critical error in weekly settlement creation:",e),"development"===b.env.NODE_ENV&&console.error("Stack trace:",e),w.NextResponse.json({error:"주간 정산 생성 중 심각한 오류가 발생했습니다",details:e instanceof Error?e.message:"알 수 없는 오류",timestamp:new Date().toISOString()},{status:500})}}e.s(["POST",()=>x],100540);var P=e.i(100540);let N=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/settlements/create-weekly/route",pathname:"/api/admin/settlements/create-weekly",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/settlements/create-weekly/route.ts",nextConfigOutput:"standalone",userland:P}),{workAsyncStorage:O,workUnitAsyncStorage:D,serverHooks:j}=N;function M(){return(0,o.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:D})}async function $(e,t,o){N.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/admin/settlements/create-weekly/route";R=R.replace(/\/index$/,"")||"/";let w=await N.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:_,params:y,nextConfig:S,parsedUrl:A,isDraftMode:E,prerenderManifest:C,routerServerContext:I,isOnDemandRevalidate:b,revalidateOnlyGenerated:x,resolvedPathname:P,clientReferenceManifest:O,serverActionsManifest:D}=w,j=(0,l.normalizeAppPath)(R),M=!!(C.dynamicRoutes[j]||C.routes[P]),$=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,A,!1):t.end("This page could not be found"),null);if(M&&!E){let e=!!C.routes[P],t=C.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await $();throw new k.NoFallbackError}}let T=null;!M||N.isDev||E||(T="/index"===(T=P)?"/":T);let G=!0===N.isDev||!M,H=M&&!G;D&&O&&(0,n.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:O,serverActionsManifest:D,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:D})});let q=e.method||"GET",U=(0,a.getTracer)(),F=U.getActiveScopeSpan(),V={params:y,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:G,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o)=>N.onRequestError(e,t,o,I)},sharedContext:{buildId:_}},B=new c.NodeNextRequest(e),W=new c.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let n=async e=>N.handle(K,V).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=U.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${q} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${R}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var a,l;let c=async({previousCacheEntry:r})=>{try{if(!i&&b&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(s);e.fetchMetrics=V.renderOpts.fetchMetrics;let l=V.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let c=V.renderOpts.collectedTags;if(!M)return await (0,p.sendResponse)(B,W,a,V.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[h.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==V.renderOpts.collectedRevalidate&&!(V.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&V.renderOpts.collectedRevalidate,o=void 0===V.renderOpts.collectedExpire||V.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:V.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})},I),t}},u=await N.handleResponse({req:e,nextConfig:S,cacheKey:T,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:x,responseGenerator:c,waitUntil:o.waitUntil,isMinimalMode:i});if(!M)return null;if((null==u||null==(a=u.value)?void 0:a.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",b?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&M||d.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(B,W,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};F?await l(F):await U.withPropagatedContext(e.headers,()=>U.trace(d.BaseServerSpan.handleRequest,{spanName:`${q} ${R}`,kind:a.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof k.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})}),M)throw t;return await (0,p.sendResponse)(B,W,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>M,"routeModule",()=>N,"serverHooks",()=>j,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>D],327031)},308812,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_better-auth_dist_chunks_bun-sqlite-dialect_mjs_ac94bb8b._.js"].map(t=>e.l(t))).then(()=>t(463259)))},922180,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_better-auth_dist_chunks_node-sqlite-dialect_mjs_29019df6._.js"].map(t=>e.l(t))).then(()=>t(8202)))},501603,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__fd3a5b9b._.js"].map(t=>e.l(t))).then(()=>t(492749)))},715957,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__05e349db._.js","server/chunks/_1aa5a6b5._.js"].map(t=>e.l(t))).then(()=>t(309653)))},578406,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__aa8ebafd._.js","server/chunks/[root-of-the-server]__aea4da49._.js","server/chunks/_46980750._.js","server/chunks/node_modules_mime-db_db_json_a85ad9f0._.js","server/chunks/node_modules_0f478c9c._.js"].map(t=>e.l(t))).then(()=>t(315159)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__968293ce._.js.map